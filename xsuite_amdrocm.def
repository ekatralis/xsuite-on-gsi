Bootstrap: docker
From: ubuntu:22.04

%labels
AUTHOR Philipp Niedermayer

%help
See https://git.gsi.de/p.niedermayer/xsuite-on-hpc

%files
example.py /xsuite/example.py

%post
apt update
apt install -y wget libnuma-dev

# install AMD drivers
######################
# see https://www.amd.com/en/support
DRIVER=https://repo.radeon.com/amdgpu-install/22.20/ubuntu/jammy/amdgpu-install_22.20.50200-1_all.deb
cd /tmp
wget $DRIVER
apt install -y ./amdgpu-install_*.deb
amdgpu-install --list-usecase
amdgpu-install --usecase=opencl --no-dkms -y
echo PATH=\"\$PATH:/opt/rocm/bin:/opt/rocm/opencl/bin\" >> /environment
echo LD_LIBRARY_PATH=\"\$LD_LIBRARY_PATH:/opt/rocm/lib:/opt/rocm/lib64\" >> /environment
echo "export PATH LD_LIBRARY_PATH" >> /environment
rm -rf /tmp/amd*
ls /etc/OpenCL/vendors
/opt/rocm/bin/clinfo

# install python and xsuite
############################
apt install -y python3 python3-pip libclfft-dev python3-gpyfft
pip install numpy==1.23.4  # see https://github.com/xsuite/xsuite/issues/399
pip install --upgrade cython ipython scipy matplotlib pandas pytest pyopencl pint tqdm
pip install cpymad
pip install PyHEADTAIL
pip install xsuite
xsuite-prebuild
pip install xplt
pip freeze

# cleanup
##########
apt purge -y wget .\*-doc$
apt autoremove -y
apt clean -y
rm -rf /var/lib/apt/lists/*
pip cache purge





