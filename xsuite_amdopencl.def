Bootstrap: docker
From: ubuntu:24.04

%labels
AUTHOR Philipp Niedermayer

%help
See https://git.gsi.de/p.niedermayer/xsuite-on-hpc

%files
example.py /xsuite/example.py

%post
export DEBIAN_FRONTEND=noninteractive
apt update
apt install -y wget libnuma-dev


# install AMD drivers
######################
# see https://www.amd.com/en/support
DRIVER=https://repo.radeon.com/amdgpu-install/6.3.4/ubuntu/noble/amdgpu-install_6.3.60304-1_all.deb
cd /tmp
wget $DRIVER
apt install -y ./amdgpu-install_*.deb
amdgpu-install --list-usecase
amdgpu-install --usecase=opencl --no-dkms -y
echo PATH=\"\$PATH:/opt/rocm/bin:/opt/rocm/opencl/bin\" >> /environment
echo LD_LIBRARY_PATH=\"\$LD_LIBRARY_PATH:/opt/rocm/lib:/opt/rocm/lib64\" >> /environment
echo "export PATH LD_LIBRARY_PATH" >> /environment
rm -rf /tmp/amd*
ls /etc/OpenCL/vendors
/opt/rocm/bin/clinfo

# install python and packages
##############################
apt install -y python3 python3-numpy python3-scipy python3-matplotlib python3-pandas python3-ipython \
               python3-pyopencl python3-tqdm libclfft-dev python3-gpyfft \
               python3-pip python3-virtualenv

# install xsuite 
#################
virtualenv --system-site-packages /xsuite-env
. /xsuite-env/bin/activate
echo '. /xsuite-env/bin/activate' >> $SINGULARITY_ENVIRONMENT
pip install siphash24
pip install cpymad
pip install h5py pyheadtail
pip install pytest pytest-mock
pip install xsuite
pip install xplt[full]
#pip install setuptools
#xsuite-prebuild regenerate
pip freeze

# cleanup
##########
apt purge -y wget .\*-doc$
apt autoremove -y
apt clean -y
rm -rf /var/lib/apt/lists/*
pip cache purge





